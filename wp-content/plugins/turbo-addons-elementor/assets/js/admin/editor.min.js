(function ($) {
    const style = document.createElement("style");
    style.innerHTML = `
        .turbo-elementor-button-hide {
            display: none !important;
        }
        .turbo-dialog-buttons-action {
            margin-top: 10px;
            display: inline-block;
        }
    `;
    parent.document.head.appendChild(style);

    // Hide Elementor's default upgrade button instantly on any dialog open
    const observer = new MutationObserver(() => {
        const dialog = parent.document.querySelector("#elementor-element--promotion__dialog");
        if (!dialog) return;

        const defaultBtn = dialog.querySelector(".elementor-button.go-pro.dialog-buttons-action");
        if (defaultBtn && !defaultBtn.classList.contains('turbo-elementor-button-hide')) {
            defaultBtn.classList.add('turbo-elementor-button-hide');
        }
    });
    observer.observe(parent.document.body, { childList: true, subtree: true });

    parent.document.addEventListener("mousedown", function (e) {
        const dialog = parent.document.querySelector("#elementor-element--promotion__dialog");
        if (dialog) {
            // Cleanup from previous Turbo state always
            dialog.classList.remove('turbo-pro-widget');
            dialog.querySelectorAll('.turbo-dialog-buttons-action').forEach(el => el.remove());

            const defaultBtn = dialog.querySelector(".elementor-button.go-pro.dialog-buttons-action");
            if (defaultBtn) {
                defaultBtn.classList.remove('turbo-elementor-button-hide');
            }
        }

        const turboPanel = parent.document.querySelector("#elementor-panel-category-trad-premium-widgets");
        if (!turboPanel) return;

        const widgets = turboPanel.querySelectorAll(".elementor-element--promotion");
        if (!widgets.length) return;

        for (let i = 0; i < widgets.length; i++) {
            if (widgets[i].contains(e.target)) {
                const title = widgets[i].querySelector(".title-wrapper > .title")?.innerText.trim();
                if (!title) return;

                const dialog = parent.document.querySelector("#elementor-element--promotion__dialog");
                if (!dialog) return;

                // Confirm again it's our panel
                if (!turboPanel.contains(widgets[i])) return;

                const urlMap = {
                    'Timeline': 'https://turbo-addons.com/time-line/',
                    'Progress Milestones': 'https://turbo-addons.com/progress-milestone/',
                    'Review Archive': 'https://turbo-addons.com/review-archive/',
                    '3D Carousel': 'https://turbo-addons.com/3d_carousel/',
                    'Testimonial Slider': 'https://turbo-addons.com/testimonial-slider/',
                    '3D Flip Box': 'https://turbo-addons.com/3d-flip-box/',
                    'Local Date': 'https://turbo-addons.com/local-date/',
                    'Post Date': 'https://turbo-addons.com/post-date/',
                    'Icon List': 'https://turbo-addons.com/icon-list/',
                    'Category Post Counter': 'https://turbo-addons.com/category-post-counter/',
                    'Advance Fatured Card': 'https://turbo-addons.com/advance-featured-card/',
                    'Post List': 'https://turbo-addons.com/post-category-list/',
                    'Image Auto Scroll': 'https://turbo-addons.com/image-auto-scroll/',
                    'Pricing Table Pro': 'https://turbo-addons.com/pricing-table-pro/',
                    'Hero Slider': 'https://turbo-addons.com/hero-slider/',
                    'Tour Guide': 'https://turbo-addons.com/user-guide/',
                    'Flip Book': 'https://turbo-addons.com/pdf-flip-book/',
                    'Text Gradient': 'https://turbo-addons.com/text-gradient/',
                    'Live Visitor Counter': 'https://turbo-addons.com/live-visitor-counter/',
                    'Word Count': 'https://turbo-addons.com/word-counter/',
                    'Advance Post Filter': 'https://turbo-addons.com/category-filter-tab/',
                    'Woo Products Card': 'https://turbo-addons.com/woo-product-cards/',
                    'WOO Product Pagination': 'https://turbo-addons.com/woo-product-pagination/',
                    'WOO Category': 'https://turbo-addons.com/woo-category/',
                    'WOO Mini Cart': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Breadcrumb': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO BuyNow Button': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Add to Cart': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Description': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Image': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Meta': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Navigation': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Price': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Rating': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Related': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Short Description': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Stock': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Tabs': 'https://turbo-addons.com/woocommerce-widgets/',
                    'WOO Product Title': 'https://turbo-addons.com/woocommerce-widgets/',
                };

                const previewURL = urlMap[title] || '#';
                const upgradeURL = 'https://turbo-addons.com/elementor-addons-pricing/';

                // âœ… Set Turbo class
                dialog.classList.add('turbo-pro-widget');

                const messageBox = dialog.querySelector(".dialog-buttons-message");
                if (messageBox) {
                    messageBox.innerHTML = `Use <strong>${title}</strong> widget and dozens more pro features to extend your toolbox and build websites faster and better.`;
                }

                const defaultBtn = dialog.querySelector(".elementor-button.go-pro.dialog-buttons-action");
                if (defaultBtn) {
                    defaultBtn.classList.add('turbo-elementor-button-hide');
                }

                const previewBtn = document.createElement('button');
                previewBtn.innerText = 'Live Preview';
                previewBtn.className = 'elementor-button turbo-dialog-buttons-action';
                previewBtn.style.backgroundColor = '#2e3192';
                previewBtn.style.color = '#fff';
                previewBtn.style.marginRight = '10px';
                previewBtn.setAttribute('role', 'link');
                previewBtn.addEventListener('mousedown', function (e) {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    setTimeout(() => window.open(previewURL, '_blank'));
                });

                const upgradeBtn = document.createElement('button');
                upgradeBtn.innerText = 'Upgrade to Pro';
                upgradeBtn.className = 'elementor-button elementor-button-danger turbo-dialog-buttons-action';
                upgradeBtn.setAttribute('role', 'link');
                upgradeBtn.addEventListener('mousedown', function (e) {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    setTimeout(() => window.open(upgradeURL, '_blank'));
                });

                const insertAfter = dialog.querySelector('.dialog-buttons-action');
                if (insertAfter && dialog.classList.contains('turbo-pro-widget')) {
                    insertAfter.insertAdjacentElement('afterend', previewBtn);
                    previewBtn.insertAdjacentElement('afterend', upgradeBtn);
                }

                break;
            }
        }
    });
})(jQuery);
